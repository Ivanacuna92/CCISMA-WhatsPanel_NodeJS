; ============================================
; DIALPLAN PARA VOICEBOT NAVETEC
; Archivo: /etc/asterisk/extensions.conf
; ============================================
; IMPORTANTE: Respalda tu archivo original antes de reemplazarlo
; sudo cp /etc/asterisk/extensions.conf /etc/asterisk/extensions.conf.backup
; ============================================

[general]
static=yes
writeprotect=no
clearglobalvars=no

; ============================================
; CONTEXTO PRINCIPAL DEL VOICEBOT
; ============================================

[voicebot-outbound]
; Este contexto es llamado desde Node.js via AMI
; Recibe el número de 10 dígitos (ej: 5512345678)
; Agrega el prefijo 96307 automáticamente
; Marca: 963075512345678

exten => _XXXXXXXXXX,1,NoOp(=== VOICEBOT: Llamada a ${EXTEN} ===)
 same => n,Set(CHANNEL(language)=es)
 same => n,Set(CALLERID(name)=Navetec)
 same => n,Set(CALLERID(num)=5212345678)
 same => n,Set(DESTINO=96307${EXTEN})
 same => n,NoOp(=== Marcando: ${DESTINO} via trunk ===)
 same => n,Progress()
 same => n,Wait(0.5)
 same => n,Dial(PJSIP/${DESTINO}@trunk-navetec,60,grtT)
 same => n,NoOp(=== Estado de llamada: ${DIALSTATUS} ===)
 same => n,GotoIf($["${DIALSTATUS}" = "ANSWER"]?answered:noanswer)

 ; Llamada contestada - Conectar con AGI de Node.js
 same => n(answered),NoOp(=== Llamada contestada, iniciando AGI ===)
 same => n,AGI(agi://127.0.0.1:4573)
 same => n,Hangup()

 ; No contestó o falló
 same => n(noanswer),NoOp(=== No contestó: ${DIALSTATUS} ===)
 same => n,Hangup()

; ============================================
; CONTEXTO PARA LLAMADAS ENTRANTES DEL TRUNK
; ============================================

[from-trunk]
exten => _X.,1,NoOp(=== Llamada entrante de ${CALLERID(num)} ===)
 same => n,Answer()
 same => n,Wait(1)
 same => n,Playback(welcome)
 same => n,Hangup()

; ============================================
; CONTEXTO DE PRUEBA (OPCIONAL)
; Para hacer pruebas manuales desde la consola de Asterisk
; ============================================

[voicebot-test]
exten => 100,1,NoOp(=== Test de Voicebot ===)
 same => n,Answer()
 same => n,Wait(1)
 same => n,Playback(demo-congrats)
 same => n,AGI(agi://127.0.0.1:4573)
 same => n,Hangup()

; ============================================
; NOTAS:
; 1. El número que recibe debe ser de 10 dígitos
; 2. Se agrega automáticamente el prefijo 96307
; 3. Ajusta CALLERID(num) con tu número real
; 4. El AGI se conecta a Node.js en puerto 4573
;
; EJEMPLOS DE USO:
; - Desde consola Asterisk:
;   channel originate PJSIP/5512345678@voicebot-outbound application Playback demo-congrats
;
; - Desde Node.js AMI:
;   Action: Originate
;   Channel: Local/5512345678@voicebot-outbound
;   Context: voicebot-outbound
;   Exten: s
;   Priority: 1
; ============================================
